#include "Font.h"

struct Glyph {
  uint32_t cp;
  uint16_t cols[6];
};

static const Glyph GLYPHS_PUNCT[] PROGMEM = {
  {0x20, {0x000,0x000,0x000,0x000,0x000,0x000}}, // space
  {0x2E, {0x000,0x006,0x006,0x000,0x000,0x000}}, // .
  {0x2C, {0x000,0x006,0x007,0x000,0x000,0x000}}, // ,
  {0x21, {0x000,0x0F6,0x0F6,0x000,0x000,0x000}}, // !
  {0x3F, {0x0C0,0x096,0x096,0x0F0,0x000,0x000}}, // ?
  {0x3A, {0x000,0x066,0x066,0x000,0x000,0x000}}, // :
  {0x3B, {0x000,0x066,0x067,0x000,0x000,0x000}}, // ;
  {0x2D, {0x010,0x010,0x010,0x010,0x010,0x000}}, // -
  {0x2B, {0x010,0x010,0x07C,0x010,0x010,0x000}}, // +
  {0x2F, {0x000,0x006,0x018,0x060,0x000,0x000}}, // /
  {0x28, {0x000,0x07C,0x082,0x000,0x000,0x000}}, // (
  {0x29, {0x000,0x000,0x082,0x07C,0x000,0x000}}, // )
};

static const Glyph GLYPHS_DIGITS[] PROGMEM = {
  {0x30, {0x07C,0x082,0x082,0x082,0x07C,0x000}}, // 0
  {0x31, {0x000,0x082,0x0FE,0x002,0x000,0x000}}, // 1
  {0x32, {0x062,0x086,0x08A,0x092,0x062,0x000}}, // 2
  {0x33, {0x044,0x092,0x092,0x092,0x06C,0x000}}, // 3
  {0x34, {0x0F0,0x010,0x010,0x010,0x0FE,0x000}}, // 4
  {0x35, {0x0F2,0x092,0x092,0x092,0x09E,0x000}}, // 5
  {0x36, {0x0FE,0x092,0x092,0x092,0x09E,0x000}}, // 6
  {0x37, {0x0C0,0x080,0x080,0x080,0x0FE,0x000}}, // 7
  {0x38, {0x0FE,0x092,0x092,0x092,0x0FE,0x000}}, // 8
  {0x39, {0x0F2,0x092,0x092,0x092,0x0FE,0x000}}, // 9
};

// A-Z
static const Glyph GLYPHS_LATIN[] PROGMEM = {
  {0x41, {0x07E,0x090,0x090,0x090,0x07E,0x000}}, // A
  {0x42, {0x0FE,0x092,0x092,0x092,0x06C,0x000}}, // B
  {0x43, {0x0FE,0x082,0x082,0x082,0x082,0x000}}, // C
  {0x44, {0x0FE,0x082,0x082,0x082,0x07C,0x000}}, // D
  {0x45, {0x0FE,0x092,0x092,0x092,0x082,0x000}}, // E
  {0x46, {0x0FE,0x090,0x090,0x090,0x080,0x000}}, // F
  {0x47, {0x0FE,0x082,0x092,0x092,0x09E,0x000}}, // G
  {0x48, {0x0FE,0x010,0x010,0x010,0x0FE,0x000}}, // H
  {0x49, {0x082,0x082,0x0FE,0x082,0x082,0x000}}, // I
  {0x4A, {0x080,0x082,0x082,0x0FC,0x080,0x000}}, // J
  {0x4B, {0x0FE,0x010,0x028,0x044,0x082,0x000}}, // K
  {0x4C, {0x0FE,0x002,0x002,0x002,0x002,0x000}}, // L
  {0x4D, {0x0FE,0x040,0x020,0x040,0x0FE,0x000}}, // M
  {0x4E, {0x0FE,0x020,0x010,0x008,0x0FE,0x000}}, // N
  {0x4F, {0x07C,0x082,0x082,0x082,0x07C,0x000}}, // O
  {0x50, {0x0FE,0x090,0x090,0x090,0x060,0x000}}, // P
  {0x51, {0x0FE,0x082,0x082,0x0FE,0x001,0x000}}, // Q
  {0x52, {0x0FE,0x098,0x094,0x092,0x0F0,0x000}}, // R
  {0x53, {0x0F2,0x092,0x092,0x092,0x09E,0x000}}, // S
  {0x54, {0x080,0x080,0x0FE,0x080,0x080,0x000}}, // T
  {0x55, {0x0FC,0x002,0x002,0x002,0x0FC,0x000}}, // U
  {0x56, {0x0F8,0x004,0x002,0x004,0x0F8,0x000}}, // V
  {0x57, {0x0FC,0x002,0x03C,0x002,0x0FC,0x000}}, // W
  {0x58, {0x0C6,0x028,0x010,0x028,0x0C6,0x000}}, // X
  {0x59, {0x0E0,0x010,0x00E,0x010,0x0E0,0x000}}, // Y
  {0x5A, {0x086,0x08A,0x092,0x0A2,0x0C2,0x000}}, // Z
};

// А-Я
static const Glyph GLYPHS_CYR[] PROGMEM = {
  {0x401, {0x0FE,0x292,0x092,0x292,0x082,0x000}}, // Ё
  {0x410, {0x07E,0x090,0x090,0x090,0x07E,0x000}}, // А
  {0x411, {0x0FE,0x092,0x092,0x092,0x09E,0x000}}, // Б
  {0x412, {0x0FE,0x092,0x092,0x092,0x06C,0x000}}, // В
  {0x413, {0x0FE,0x080,0x080,0x080,0x080,0x000}}, // Г
  {0x414, {0x006,0x0FC,0x084,0x084,0x0FC,0x006}}, // Д
  {0x415, {0x0FE,0x092,0x092,0x092,0x082,0x000}}, // Е
  {0x416, {0x0C6,0x028,0x0FE,0x028,0x0C6,0x000}}, // Ж
  {0x417, {0x082,0x092,0x092,0x092,0x06C,0x000}}, // З
  {0x418, {0x0FE,0x008,0x010,0x020,0x0FE,0x000}}, // И
  {0x419, {0x0FE,0x008,0x210,0x020,0x0FE,0x000}}, // Й
  {0x41A, {0x0FE,0x010,0x028,0x044,0x082,0x000}}, // К
  {0x41B, {0x002,0x0FE,0x080,0x080,0x0FE,0x000}}, // Л
  {0x41C, {0x0FE,0x040,0x020,0x040,0x0FE,0x000}}, // М
  {0x41D, {0x0FE,0x010,0x010,0x010,0x0FE,0x000}}, // Н
  {0x41E, {0x07C,0x082,0x082,0x082,0x07C,0x000}}, // О
  {0x41F, {0x0FE,0x080,0x080,0x080,0x0FE,0x000}}, // П
  {0x420, {0x0FE,0x090,0x090,0x090,0x060,0x000}}, // Р
  {0x421, {0x0FE,0x082,0x082,0x082,0x082,0x000}}, // С
  {0x422, {0x080,0x080,0x0FE,0x080,0x080,0x000}}, // Т
  {0x423, {0x0F2,0x012,0x012,0x012,0x0FE,0x000}}, // У
  {0x424, {0x0F0,0x090,0x0FE,0x090,0x0F0,0x000}}, // Ф
  {0x425, {0x0C6,0x028,0x010,0x028,0x0C6,0x000}}, // Х
  {0x426, {0x0FE,0x002,0x002,0x002,0x0FE,0x003}}, // Ц
  {0x427, {0x0F0,0x010,0x010,0x010,0x0FE,0x000}}, // Ч
  {0x428, {0x0FE,0x002,0x03E,0x002,0x0FE,0x000}}, // Ш
  {0x429, {0x0FE,0x002,0x03E,0x002,0x0FE,0x003}}, // Щ
  {0x42A, {0x080,0x0FE,0x012,0x012,0x012,0x00C}}, // Ъ
  {0x42B, {0x0FE,0x012,0x012,0x00C,0x000,0x0FE}}, // Ы
  {0x42C, {0x0FE,0x012,0x012,0x012,0x00C,0x000}}, // Ь
  {0x42D, {0x000,0x082,0x092,0x092,0x07C,0x000}}, // Э
  {0x42E, {0x0FE,0x010,0x07C,0x082,0x082,0x07C}}, // Ю
  {0x42F, {0x062,0x094,0x098,0x090,0x0FE,0x000}}, // Я
};

uint32_t Font::normalize(uint32_t cp) {
  if (cp >= (uint32_t)'a' && cp <= (uint32_t)'z') {
    return cp - 32;
  }

  if (cp >= 0x430 && cp <= 0x44F) {
    return cp - 0x20;
  }
  if (cp == 0x451) {
    return 0x401;
  }

  return cp;
}

static bool readGlyphFromTable(const Glyph* table, size_t count, uint32_t cp, uint16_t outCols[Font::W]) {
  for (size_t i = 0; i < count; i++) {
    Glyph g;
    memcpy_P(&g, &table[i], sizeof(Glyph));

    if (g.cp == cp) {
      memcpy(outCols, g.cols, sizeof(g.cols));
      return true;
    }
  }
  return false;
}

bool Font::getGlyph(uint32_t codepoint, uint16_t outCols[Font::W]) {
  uint32_t cp = normalize(codepoint);

  if (readGlyphFromTable(GLYPHS_PUNCT,  sizeof(GLYPHS_PUNCT)  / sizeof(Glyph), cp, outCols)) return true;
  if (readGlyphFromTable(GLYPHS_DIGITS, sizeof(GLYPHS_DIGITS) / sizeof(Glyph), cp, outCols)) return true;
  if (readGlyphFromTable(GLYPHS_LATIN,  sizeof(GLYPHS_LATIN)  / sizeof(Glyph), cp, outCols)) return true;
  if (readGlyphFromTable(GLYPHS_CYR,    sizeof(GLYPHS_CYR)    / sizeof(Glyph), cp, outCols)) return true;

  static const uint16_t q[Font::W] = {0x002, 0x001, 0x059, 0x006, 0x000, 0x000};
  memcpy(outCols, q, sizeof(q));
  return false;
}
